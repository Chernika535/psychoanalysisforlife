<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рабочая тетрадь самопознания</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #2c3e50;
            padding: 20px 16px;
            text-align: center;
            margin: -16px -16px 20px -16px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.8;
        }

        .progress-bar {
            background: rgba(44, 62, 80, 0.2);
            height: 6px;
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            background: #FF8C00;
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .tab-navigation {
            display: flex;
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            min-width: 70px;
            padding: 12px 6px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            color: var(--tg-theme-hint-color, #999);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: #FFD700;
            color: #2c3e50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000);
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--tg-theme-text-color, #000);
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            font-size: 14px;
            background: var(--tg-theme-bg-color, white);
            color: var(--tg-theme-text-color, #000);
            resize: vertical;
            min-height: 40px;
        }

        .input-field:focus {
            outline: none;
            border-color: #FFD700;
        }

        .textarea {
            min-height: 80px;
        }

        .scale-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .scale-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--tg-theme-hint-color, #ddd);
            outline: none;
            -webkit-appearance: none;
        }

        .scale-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
        }

        .scale-value {
            font-weight: 600;
            min-width: 30px;
            text-align: center;
            color: #FF8C00;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox.checked {
            background: #FFD700;
            border-color: #FFD700;
        }

        .checkbox.checked::after {
            content: '✓';
            color: #2c3e50;
            font-size: 12px;
            font-weight: bold;
        }

        .btn {
            background: #FFD700;
            color: #2c3e50;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s ease;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000);
        }

        .daily-tracker {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 16px 0;
        }

        .day-cell {
            aspect-ratio: 1;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .day-cell.completed {
            background: #FFD700;
            color: #2c3e50;
            border-color: #FFD700;
        }

        .day-cell.current {
            background: #FFF3CD;
            border-color: #FF8C00;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .stat-card {
            background: var(--tg-theme-bg-color, white);
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FF8C00;
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666);
            margin-top: 4px;
        }

        .journal-entry {
            background: var(--tg-theme-bg-color, white);
            border: 1px solid #FFD700;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            position: relative;
        }

        .journal-date {
            font-size: 12px;
            color: #FF8C00;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .journal-content {
            font-size: 14px;
            line-height: 1.4;
        }

        .journal-type {
            display: inline-block;
            background: #FFD700;
            color: #2c3e50;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 8px;
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            opacity: 0.8;
        }

        .weekly-summary {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #2c3e50;
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
            position: relative;
        }

        .summary-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .summary-section {
            margin-bottom: 12px;
        }

        .summary-label {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: #FFD700;
            color: #2c3e50;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 1px solid #FFD700;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .no-entries {
            text-align: center;
            color: var(--tg-theme-hint-color, #999);
            padding: 40px 20px;
            font-style: italic;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFD700;
            color: #2c3e50;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .emergency-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
        }

        .breathing-guide {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #2c3e50;
            border-radius: 12px;
            margin: 16px 0;
        }

        .breathing-circle {
            width: 100px;
            height: 100px;
            border: 3px solid #2c3e50;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            animation: breathe 4s infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .technique-card {
            background: var(--tg-theme-bg-color, white);
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }

        .technique-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000);
        }

        .reminder-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .reminder-info {
            font-size: 14px;
            color: #856404;
            margin-bottom: 12px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            
            .header {
                margin: -12px -12px 16px -12px;
                padding: 16px 12px;
            }
            
            .tab-btn {
                font-size: 10px;
                padding: 10px 4px;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Рабочая тетрадь самопознания</h1>
            <p>Трансформация внутренних барьеров в жизненные достижения</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Главная</button>
            <button class="tab-btn" onclick="switchTab('journal')">Журнал</button>
            <button class="tab-btn" onclick="switchTab('summaries')">Сводки</button>
            <button class="tab-btn" onclick="switchTab('diagnosis')">Диагностика</button>
            <button class="tab-btn" onclick="switchTab('defense')">Защиты</button>
            <button class="tab-btn" onclick="switchTab('symbols')">Символы</button>
            <button class="tab-btn" onclick="switchTab('plan')">План</button>
            <button class="tab-btn" onclick="switchTab('emergency')">SOS</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="section">
                <div class="section-title">Ваш прогресс</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="completedDays">0</div>
                        <div class="stat-label">Дней практики</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentStreak">0</div>
                        <div class="stat-label">Текущая серия</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgAnxiety">-</div>
                        <div class="stat-label">Средняя тревога</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedSections">0</div>
                        <div class="stat-label">Разделов заполнено</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Ежедневный трекер</div>
                <div class="daily-tracker" id="dailyTracker"></div>
                
                <div class="input-group">
                    <label class="input-label">Уровень тревоги сегодня (1-10)</label>
                    <div class="scale-input">
                        <span>1</span>
                        <input type="range" class="scale-slider" min="1" max="10" value="5" id="todayAnxiety" oninput="updateAnxietyValue(this.value)">
                        <span>10</span>
                        <div class="scale-value" id="anxietyValue">5</div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Заметки дня</label>
                    <textarea class="input-field textarea" id="todayNotes" placeholder="Что важного заметили сегодня?"></textarea>
                </div>

                <button class="btn" onclick="saveDailyEntry()">Сохранить запись дня</button>
            </div>

            <div class="reminder-section">
                <div class="section-title">Напоминания</div>
                <div class="reminder-info">
                    Чтобы получать ежедневные напоминания о заполнении тетради:
                </div>
                <ol style="margin-left: 20px; color: #856404;">
                    <li>Откройте настройки Telegram</li>
                    <li>Найдите раздел "Уведомления и звуки"</li>
                    <li>Включите уведомления для ботов</li>
                    <li>Настройте время "Не беспокоить" так, чтобы в вечернее время (19-21) уведомления приходили</li>
                </ol>
                <div style="font-size: 12px; color: #856404; margin-top: 8px;">
                    Рекомендуем заполнять тетрадь каждый вечер в одно и то же время для формирования привычки.
                </div>
            </div>
        </div>

        <!-- Journal Tab -->
        <div id="journal" class="tab-content">
            <div class="section">
                <div class="section-title">Журнал всех записей</div>
                
                <input type="text" class="search-box" id="journalSearch" placeholder="🔍 Поиск по записям..." oninput="filterJournal()">
                
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterJournalByType('all')">Все</button>
                    <button class="filter-btn" onclick="filterJournalByType('daily')">Ежедневные</button>
                    <button class="filter-btn" onclick="filterJournalByType('defense')">Защиты</button>
                    <button class="filter-btn" onclick="filterJournalByType('symbols')">Символы</button>
                    <button class="filter-btn" onclick="filterJournalByType('diagnosis')">Диагностика</button>
                </div>
                
                <div id="journalEntries">
                    <div class="no-entries">Записей пока нет. Начните заполнять разделы!</div>
                </div>
            </div>
        </div>

        <!-- Weekly Summaries Tab -->
        <div id="summaries" class="tab-content">
            <div class="section">
                <div class="section-title">Еженедельные сводки</div>
                <p style="margin-bottom: 16px;">Автоматические сводки всех ваших записей за неделю для лучшего понимания динамики.</p>
                
                <button class="btn" onclick="generateWeeklySummary()">📊 Создать сводку за эту неделю</button>
                
                <div id="weeklySummaries">
                    <div class="no-entries">Сводок пока нет. Создайте первую!</div>
                </div>
            </div>
        </div>

        <!-- Diagnosis Tab -->
        <div id="diagnosis" class="tab-content">
            <div class="section">
                <div class="section-title">Карта текущей жизни</div>
                <p style="margin-bottom: 16px;">Оцените удовлетворенность по шкале 1-10:</p>
                
                <div class="input-group">
                    <label class="input-label">Карьера и профессия</label>
                    <div class="scale-input">
                        <span>1</span>
                        <input type="range" class="scale-slider" min="1" max="10" value="5" id="careerSat" oninput="updateScaleValue('career', this.value)">
                        <span>10</span>
                        <div class="scale-value" id="careerValue">5</div>
                    </div>
                    <textarea class="input-field" id="careerNotes" placeholder="Что не устраивает..."></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">Отношения (романтические)</label>
                    <div class="scale-input">
                        <span>1</span>
                        <input type="range" class="scale-slider" min="1" max="10" value="5" id="relationshipSat" oninput="updateScaleValue('relationship', this.value)">
                        <span>10</span>
                        <div class="scale-value" id="relationshipValue">5</div>
                    </div>
                    <textarea class="input-field" id="relationshipNotes" placeholder="Что не устраивает..."></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">Семья и друзья</label>
                    <div class="scale-input">
                        <span>1</span>
                        <input type="range" class="scale-slider" min="1" max="10" value="5" id="familySat" oninput="updateScaleValue('family', this.value)">
                        <span>10</span>
                        <div class="scale-value" id="familyValue">5</div>
                    </div>
                    <textarea class="input-field" id="familyNotes" placeholder="Что не устраивает..."></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">Здоровье и энергия</label>
                    <div class="scale-input">
                        <span>1</span>
                        <input type="range" class="scale-slider" min="1" max="10" value="5" id="healthSat" oninput="updateScaleValue('health', this.value)">
                        <span>10</span>
                        <div class="scale-value" id="healthValue">5</div>
                    </div>
                    <textarea class="input-field" id="healthNotes" placeholder="Что не устраивает..."></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">Финансы</label>
                    <div class="scale-input">
                        <span>1</span>
                        <input type="range" class="scale-slider" min="1" max="10" value="5" id="financeSat" oninput="updateScaleValue('finance', this.value)">
                        <span>10</span>
                        <div class="scale-value" id="financeValue">5</div>
                    </div>
                    <textarea class="input-field" id="financeNotes" placeholder="Что не устраивает..."></textarea>
                </div>

                <button class="btn" onclick="saveDiagnosis()">Сохранить диагностику</button>
            </div>

            <div class="section">
                <div class="section-title">Застрявшие цели</div>
                
                <div class="input-group">
                    <label class="input-label">Цель 1</label>
                    <input type="text" class="input-field" id="goal1" placeholder="Цель, которая не движется...">
                    <input type="text" class="input-field" id="goal1Time" placeholder="Как долго не движется?" style="margin-top: 8px;">
                    <textarea class="input-field" id="goal1Reasons" placeholder="Формальные причины..." style="margin-top: 8px;"></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">Цель 2</label>
                    <input type="text" class="input-field" id="goal2" placeholder="Цель, которая не движется...">
                    <input type="text" class="input-field" id="goal2Time" placeholder="Как долго не движется?" style="margin-top: 8px;">
                    <textarea class="input-field" id="goal2Reasons" placeholder="Формальные причины..." style="margin-top: 8px;"></textarea>
                </div>

                <button class="btn" onclick="saveGoals()">Сохранить цели</button>
            </div>
        </div>

        <!-- Defense Tab -->
        <div id="defense" class="tab-content">
            <div class="section">
                <div class="section-title">Дневник защитных реакций</div>
                <p style="margin-bottom: 16px;">Отслеживайте моменты дискомфорта и свои реакции:</p>
                
                <div class="input-group">
                    <label class="input-label">Ситуация, вызвавшая дискомфорт</label>
                    <textarea class="input-field" id="defenseReason" placeholder="Что произошло?"></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">Ваша первая реакция</label>
                    <textarea class="input-field" id="defenseReaction" placeholder="Что подумали/сделали первым делом?"></textarea>
                </div>

                <button class="btn" onclick="addDefenseEntry()">Добавить запись</button>
            </div>

            <div class="section">
                <div class="section-title">Анализ ваших защит</div>
                
                <div class="input-group">
                    <label class="input-label">Какие защиты используете чаще всего?</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <div class="checkbox" onclick="toggleCheckbox('denial')" id="denialCheck"></div>
                            <span>Отрицание ("Все нормально")</span>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox" onclick="toggleCheckbox('projection')" id="projectionCheck"></div>
                            <span>Проекция ("Они виноваты")</span>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox" onclick="toggleCheckbox('rationalization')" id="rationalizationCheck"></div>
                            <span>Рационализация ("У меня есть причины")</span>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox" onclick="toggleCheckbox('avoidance')" id="avoidanceCheck"></div>
                            <span>Избегание ("Лучше не рисковать")</span>
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="saveDefenseAnalysis()">Сохранить анализ</button>
            </div>
        </div>

        <!-- Symbols Tab -->
        <div id="symbols" class="tab-content">
            <div class="section">
                <div class="section-title">Символический дневник</div>
                
                <div class="input-group">
                    <label class="input-label">Сегодняшний сон</label>
                    <textarea class="input-field" id="todayDream" placeholder="Что снилось? (даже фрагменты)"></textarea>
                </div>

                <div class="input-group">
                    <label class="input-label">Эмоция от сна</label>
                    <input type="text" class="input-field" id="dreamEmotion" placeholder="Что чувствовали во сне и после?">
                </div>

                <div class="input-group">
                    <label class="input-label">Оговорки, забывчивость</label>
                    <textarea class="input-field" id="slipsOfTongue" placeholder="Что сказали не то или забыли?"></textarea>
                </div>

                <button class="btn" onclick="addSymbolEntry()">Добавить запись дня</button>
            </div>
        </div>

        <!-- Plan Tab -->
        <div id="plan" class="tab-content">
            <div class="section">
                <div class="section-title">Месячный план</div>
                
                <div class="input-group">
                    <label class="input-label">Фокус месяца</label>
                    <input type="text" class="input-field" id="monthFocus" placeholder="Над чем работаем?">
                </div>

                <div class="input-group">
                    <label class="input-label">Неделя 1 - Действие</label>
                    <input type="text" class="input-field" id="week1Action" placeholder="Конкретное действие">
                </div>

                <div class="input-group">
                    <label class="input-label">Неделя 2 - Действие</label>
                    <input type="text" class="input-field" id="week2Action" placeholder="Конкретное действие">
                </div>

                <button class="btn" onclick="saveMonthlyPlan()">Сохранить план</button>
            </div>
        </div>

        <!-- Emergency Tab -->
        <div id="emergency" class="tab-content">
            <div class="section">
                <div class="section-title">SOS: Экстренная помощь</div>
                
                <button class="emergency-btn" onclick="startBreathingExercise()">🫁 Дыхательная техника 4-7-8</button>
                <button class="emergency-btn" onclick="show54321Technique()">🧠 Техника заземления 5-4-3-2-1</button>
                <button class="emergency-btn" onclick="showSelfCompassion()">💝 Практика самосострадания</button>
                <button class="emergency-btn" onclick="showProgressReminder()">📈 Напоминание о прогрессе</button>
            </div>

            <div class="breathing-guide" id="breathingGuide" style="display: none;">
                <h3>Дыхательная техника 4-7-8</h3>
                <div class="breathing-circle" id="breathingCircle">Вдох 4</div>
                <p>Следуйте инструкциям в круге</p>
                <button class="btn btn-secondary" onclick="stopBreathingExercise()">Остановить</button>
            </div>

            <div class="technique-card" id="technique54321" style="display: none;">
                <div class="technique-title">Техника заземления 5-4-3-2-1</div>
                <p><strong>Назовите:</strong></p>
                <ul>
                    <li>5 вещей, которые вы ВИДИТЕ</li>
                    <li>4 вещи, которые вы СЛЫШИТЕ</li>
                    <li>3 вещи, которые можете ПОТРОГАТЬ</li>
                    <li>2 запаха, которые ЧУВСТВУЕТЕ</li>
                    <li>1 вкус, который можете РАЗЛИЧИТЬ</li>
                </ul>
                <button class="btn btn-secondary" onclick="hide54321Technique()">Закрыть</button>
            </div>

            <div class="technique-card" id="selfCompassionCard" style="display: none;">
                <div class="technique-title">Практика самосострадания</div>
                <p><strong>Скажите себе:</strong></p>
                <ul>
                    <li>"Сейчас мне трудно, и это нормально"</li>
                    <li>"Трудности — это часть человеческого опыта"</li>
                    <li>"Я отношусь к себе с добротой и пониманием"</li>
                    <li>"Что бы я сказал лучшему другу в такой ситуации?"</li>
                </ul>
                <button class="btn btn-secondary" onclick="hideSelfCompassion()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Toast for notifications -->
    <div class="toast" id="toast"></div>

    <script>
        // Initialize Telegram WebApp
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // Data storage
        let appData = {
            progress: {
                completedDays: 0,
                currentStreak: 0,
                completedSections: 0,
                dailyEntries: [],
                anxietyHistory: []
            },
            journalEntries: [],
            weeklySummaries: []
        };

        // Load data from localStorage
        function loadData() {
            try {
                const savedData = localStorage.getItem('psychoanalysisData');
                if (savedData) {
                    appData = { ...appData, ...JSON.parse(savedData) };
                    updateDashboard();
                    updateProgressBar();
                    initializeDailyTracker();
                    loadJournalEntries();
                    loadWeeklySummaries();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('psychoanalysisData', JSON.stringify(appData));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hide all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Mark button as active
            event.target.classList.add('active');
        }

        // Update anxiety value display
        function updateAnxietyValue(value) {
            const display = document.getElementById('anxietyValue');
            if (display) {
                display.textContent = value;
            }
        }

        // Update scale value display
        function updateScaleValue(type, value) {
            const display = document.getElementById(type + 'Value');
            if (display) {
                display.textContent = value;
            }
        }

        // Update progress bar
        function updateProgressBar() {
            const totalSections = 8; // Общее количество основных разделов
            const completed = appData.progress.completedSections;
            const percentage = Math.min((completed / totalSections) * 100, 100);
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = percentage + '%';
            }
        }

        // Update dashboard stats
        function updateDashboard() {
            const elements = {
                completedDays: document.getElementById('completedDays'),
                currentStreak: document.getElementById('currentStreak'),
                completedSections: document.getElementById('completedSections'),
                avgAnxiety: document.getElementById('avgAnxiety')
            };

            if (elements.completedDays) {
                elements.completedDays.textContent = appData.progress.completedDays;
            }
            if (elements.currentStreak) {
                elements.currentStreak.textContent = appData.progress.currentStreak;
            }
            if (elements.completedSections) {
                elements.completedSections.textContent = appData.progress.completedSections;
            }
            
            // Calculate average anxiety
            if (elements.avgAnxiety && appData.progress.anxietyHistory.length > 0) {
                const avg = appData.progress.anxietyHistory.reduce((a, b) => a + b, 0) / appData.progress.anxietyHistory.length;
                elements.avgAnxiety.textContent = avg.toFixed(1);
            }
        }

        // Initialize daily tracker
        function initializeDailyTracker() {
            const tracker = document.getElementById('dailyTracker');
            if (!tracker) return;
            
            tracker.innerHTML = '';
            
            for (let i = 0; i < 28; i++) {
                const day = document.createElement('div');
                day.className = 'day-cell';
                day.textContent = i + 1;
                
                const today = new Date().getDate();
                if (i + 1 === today) {
                    day.classList.add('current');
                }
                
                if (appData.progress.dailyEntries.includes(i + 1)) {
                    day.classList.add('completed');
                }
                
                tracker.appendChild(day);
            }
        }

        // Add entry to journal
        function addJournalEntry(type, title, content, data = {}) {
            const entry = {
                id: Date.now(),
                date: new Date().toISOString(),
                type: type,
                title: title,
                content: content,
                data: data
            };
            
            if (!appData.journalEntries) {
                appData.journalEntries = [];
            }
            
            appData.journalEntries.unshift(entry);
            saveData();
            loadJournalEntries();
        }

        // Delete journal entry
        function deleteJournalEntry(entryId) {
            if (confirm('Удалить эту запись?')) {
                appData.journalEntries = appData.journalEntries.filter(entry => entry.id !== entryId);
                saveData();
                loadJournalEntries();
                showToast('Запись удалена');
            }
        }

        // Load and display journal entries
        function loadJournalEntries() {
            const container = document.getElementById('journalEntries');
            if (!container) return;
            
            if (!appData.journalEntries || appData.journalEntries.length === 0) {
                container.innerHTML = '<div class="no-entries">Записей пока нет. Начните заполнять разделы!</div>';
                return;
            }
            
            let html = '';
            appData.journalEntries.forEach(entry => {
                const date = new Date(entry.date).toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="journal-entry" data-type="${entry.type}">
                        <button class="delete-btn" onclick="deleteJournalEntry(${entry.id})" title="Удалить запись">×</button>
                        <div class="journal-date">
                            <span class="journal-type">${getTypeLabel(entry.type)}</span>
                            ${date}
                        </div>
                        <div class="journal-content">
                            <strong>${entry.title}</strong><br>
                            ${entry.content}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Get type label for journal entries
        function getTypeLabel(type) {
            const labels = {
                'daily': 'Ежедневная запись',
                'defense': 'Защитные механизмы',
                'symbols': 'Символы',
                'diagnosis': 'Диагностика',
                'goals': 'Цели',
                'plan': 'План'
            };
            return labels[type] || type;
        }

        // Filter journal by type
        function filterJournalByType(type) {
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const entries = document.querySelectorAll('.journal-entry');
            entries.forEach(entry => {
                if (type === 'all' || entry.dataset.type === type) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        }

        // Filter journal by search
        function filterJournal() {
            const searchTerm = document.getElementById('journalSearch').value.toLowerCase();
            const entries = document.querySelectorAll('.journal-entry');
            
            entries.forEach(entry => {
                const content = entry.textContent.toLowerCase();
                if (content.includes(searchTerm)) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        }

        // Generate weekly summary
        function generateWeeklySummary() {
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);
            
            // Filter entries from this week
            const weekEntries = appData.journalEntries ? appData.journalEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= weekStart && entryDate < weekEnd;
            }) : [];
            
            // Calculate stats
            const anxietyThisWeek = appData.progress.anxietyHistory.slice(-7);
            const avgAnxiety = anxietyThisWeek.length > 0 ? 
                (anxietyThisWeek.reduce((a, b) => a + b, 0) / anxietyThisWeek.length).toFixed(1) : 'н/д';
            
            // Group entries by type
            const entriesByType = {};
            weekEntries.forEach(entry => {
                if (!entriesByType[entry.type]) {
                    entriesByType[entry.type] = [];
                }
                entriesByType[entry.type].push(entry);
            });
            
            // Create summary
            const summary = {
                id: Date.now(),
                weekStart: weekStart.toISOString(),
                weekEnd: weekEnd.toISOString(),
                totalEntries: weekEntries.length,
                avgAnxiety: avgAnxiety,
                entriesByType: entriesByType,
                keyInsights: generateKeyInsights(weekEntries),
                created: new Date().toISOString()
            };
            
            if (!appData.weeklySummaries) {
                appData.weeklySummaries = [];
            }
            
            appData.weeklySummaries.unshift(summary);
            saveData();
            loadWeeklySummaries();
            showToast('Сводка за неделю создана!');
        }

        // Generate key insights
        function generateKeyInsights(entries) {
            const insights = [];
            
            // Count entries by type
            const typeCount = {};
            entries.forEach(entry => {
                typeCount[entry.type] = (typeCount[entry.type] || 0) + 1;
            });
            
            // Most active area
            const mostActive = Object.entries(typeCount).sort((a, b) => b[1] - a[1])[0];
            if (mostActive) {
                insights.push(`Больше всего работали с: ${getTypeLabel(mostActive[0])} (${mostActive[1]} записей)`);
            }
            
            if (entries.length === 0) {
                insights.push('На этой неделе записей не было - время активнее заниматься самопознанием!');
            } else if (entries.length >= 7) {
                insights.push('Отличная активность! Делали записи почти каждый день');
            }
            
            return insights;
        }

        // Load weekly summaries
        function loadWeeklySummaries() {
            const container = document.getElementById('weeklySummaries');
            if (!container) return;
            
            if (!appData.weeklySummaries || appData.weeklySummaries.length === 0) {
                container.innerHTML = '<div class="no-entries">Сводок пока нет. Создайте первую!</div>';
                return;
            }
            
            let html = '';
            appData.weeklySummaries.forEach(summary => {
                const weekStart = new Date(summary.weekStart).toLocaleDateString('ru-RU');
                const weekEnd = new Date(summary.weekEnd).toLocaleDateString('ru-RU');
                
                html += `
                    <div class="weekly-summary">
                        <button class="delete-btn" onclick="deleteWeeklySummary(${summary.id})" title="Удалить сводку">×</button>
                        <div class="summary-title">Сводка ${weekStart} - ${weekEnd}</div>
                        
                        <div class="summary-section">
                            <div class="summary-label">Общая активность:</div>
                            Всего записей: ${summary.totalEntries}<br>
                            Средняя тревожность: ${summary.avgAnxiety}/10
                        </div>
                        
                        <div class="summary-section">
                            <div class="summary-label">Активность по разделам:</div>
                            ${Object.entries(summary.entriesByType).map(([type, entries]) => 
                                `${getTypeLabel(type)}: ${entries.length} записей`
                            ).join('<br>') || 'Записей не было'}
                        </div>
                        
                        <div class="summary-section">
                            <div class="summary-label">Ключевые инсайты:</div>
                            ${summary.keyInsights.map(insight => `• ${insight}`).join('<br>')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Delete weekly summary
        function deleteWeeklySummary(summaryId) {
            if (confirm('Удалить эту сводку?')) {
                appData.weeklySummaries = appData.weeklySummaries.filter(summary => summary.id !== summaryId);
                saveData();
                loadWeeklySummaries();
                showToast('Сводка удалена');
            }
        }

        // Checkbox toggle
        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id + 'Check');
            if (checkbox) {
                checkbox.classList.toggle('checked');
            }
        }

        // Save daily entry
        function saveDailyEntry() {
            const anxietySlider = document.getElementById('todayAnxiety');
            const notesField = document.getElementById('todayNotes');
            
            if (!anxietySlider || !notesField) return;
            
            const anxiety = anxietySlider.value;
            const notes = notesField.value;
            const today = new Date().getDate();
            
            appData.progress.anxietyHistory.push(parseInt(anxiety));
            if (!appData.progress.dailyEntries.includes(today)) {
                appData.progress.dailyEntries.push(today);
                appData.progress.completedDays++;
                
                // Update streak
                if (appData.progress.dailyEntries.includes(today - 1) || today === 1) {
                    appData.progress.currentStreak++;
                } else {
                    appData.progress.currentStreak = 1;
                }
            }
            
            // Add to journal
            addJournalEntry('daily', 
                `Запись дня - тревога ${anxiety}/10`, 
                notes || 'Без заметок',
                { anxiety: anxiety }
            );
            
            saveData();
            updateDashboard();
            initializeDailyTracker();
            showToast('Запись дня сохранена!');
        }

        // Save diagnosis
        function saveDiagnosis() {
            const areas = ['career', 'relationship', 'family', 'health', 'finance'];
            let diagnosisText = 'Диагностика удовлетворенности: ';
            
            areas.forEach(area => {
                const satSlider = document.getElementById(area + 'Sat');
                const notesField = document.getElementById(area + 'Notes');
                if (satSlider) {
                    const satisfaction = satSlider.value;
                    const notes = notesField ? notesField.value : '';
                    diagnosisText += `${getAreaLabel(area)}: ${satisfaction}/10`;
                    if (notes) diagnosisText += ` (${notes})`;
                    diagnosisText += '; ';
                }
            });
            
            addJournalEntry('diagnosis', 'Диагностика жизненных сфер', diagnosisText);
            
            appData.progress.completedSections = Math.max(appData.progress.completedSections, 1);
            saveData();
            updateProgressBar();
            showToast('Диагностика сохранена!');
        }

        // Get area label
        function getAreaLabel(area) {
            const labels = {
                'career': 'Карьера',
                'relationship': 'Отношения',
                'family': 'Семья',
                'health': 'Здоровье',
                'finance': 'Финансы'
            };
            return labels[area] || area;
        }

        // Save goals
        function saveGoals() {
            let goalsText = 'Застрявшие цели: ';
            
            for (let i = 1; i <= 2; i++) {
                const goal = document.getElementById(`goal${i}`);
                const time = document.getElementById(`goal${i}Time`);
                const reasons = document.getElementById(`goal${i}Reasons`);
                
                if (goal && goal.value) {
                    goalsText += `${i}. ${goal.value}`;
                    if (time && time.value) goalsText += ` (застряла: ${time.value})`;
                    if (reasons && reasons.value) goalsText += ` - причины: ${reasons.value}`;
                    goalsText += '; ';
                }
            }
            
            addJournalEntry('goals', 'Анализ застрявших целей', goalsText);
            
            appData.progress.completedSections = Math.max(appData.progress.completedSections, 2);
            saveData();
            updateProgressBar();
            showToast('Цели сохранены!');
        }

        // Add defense entry
        function addDefenseEntry() {
            const reason = document.getElementById('defenseReason');
            const reaction = document.getElementById('defenseReaction');
            
            if (!reason || !reaction) return;
            
            const reasonText = reason.value;
            const reactionText = reaction.value;
            
            if (!reasonText.trim() || !reactionText.trim()) {
                showToast('Заполните все поля');
                return;
            }
            
            addJournalEntry('defense', 
                'Защитная реакция', 
                `Ситуация: ${reasonText}. Реакция: ${reactionText}`
            );
            
            // Clear form
            reason.value = '';
            reaction.value = '';
            
            saveData();
            showToast('Запись о защитной реакции добавлена!');
        }

        // Save defense analysis
        function saveDefenseAnalysis() {
            const defenses = [];
            ['denial', 'projection', 'rationalization', 'avoidance'].forEach(defense => {
                const checkbox = document.getElementById(defense + 'Check');
                if (checkbox && checkbox.classList.contains('checked')) {
                    defenses.push(defense);
                }
            });
            
            const defenseText = defenses.length > 0 ? 
                `Выявленные защиты: ${defenses.join(', ')}` : 
                'Защиты не выбраны';
            
            addJournalEntry('defense', 'Анализ защитных механизмов', defenseText);
            
            appData.progress.completedSections = Math.max(appData.progress.completedSections, 3);
            saveData();
            updateProgressBar();
            showToast('Анализ защит сохранен!');
        }

        // Add symbol entry
        function addSymbolEntry() {
            const dream = document.getElementById('todayDream');
            const dreamEmotion = document.getElementById('dreamEmotion');
            const slips = document.getElementById('slipsOfTongue');
            
            if (!dream || !dreamEmotion || !slips) return;
            
            const symbolText = `Сон: ${dream.value || 'не помню'}. Эмоция: ${dreamEmotion.value || 'нейтральная'}. Оговорки: ${slips.value || 'не было'}`;
            
            addJournalEntry('symbols', 'Символическая запись дня', symbolText);
            
            // Clear form
            dream.value = '';
            dreamEmotion.value = '';
            slips.value = '';
            
            appData.progress.completedSections = Math.max(appData.progress.completedSections, 4);
            saveData();
            updateProgressBar();
            showToast('Символическая запись добавлена!');
        }

        // Save monthly plan
        function saveMonthlyPlan() {
            const monthFocus = document.getElementById('monthFocus');
            const week1Action = document.getElementById('week1Action');
            const week2Action = document.getElementById('week2Action');
            
            if (!monthFocus || !week1Action || !week2Action) return;
            
            const planText = `Фокус: ${monthFocus.value}. Неделя 1: ${week1Action.value}. Неделя 2: ${week2Action.value}`;
            
            addJournalEntry('plan', 'Месячный план трансформации', planText);
            
            appData.progress.completedSections = Math.max(appData.progress.completedSections, 5);
            saveData();
            updateProgressBar();
            showToast('План месяца сохранен!');
        }

        // Emergency techniques
        function startBreathingExercise() {
            const guide = document.getElementById('breathingGuide');
            const circle = document.getElementById('breathingCircle');
            
            if (!guide || !circle) return;
            
            guide.style.display = 'block';
            
            let step = 0;
            const steps = ['Вдох 4', 'Задержка 7', 'Выдох 8', 'Пауза'];
            const durations = [4000, 7000, 8000, 1000];
            
            function breathingCycle() {
                circle.textContent = steps[step];
                
                setTimeout(() => {
                    step = (step + 1) % 4;
                    if (guide.style.display !== 'none') {
                        breathingCycle();
                    }
                }, durations[step]);
            }
            
            breathingCycle();
        }

        function stopBreathingExercise() {
            const guide = document.getElementById('breathingGuide');
            if (guide) {
                guide.style.display = 'none';
            }
        }

        function show54321Technique() {
            const technique = document.getElementById('technique54321');
            if (technique) {
                technique.style.display = 'block';
            }
        }

        function hide54321Technique() {
            const technique = document.getElementById('technique54321');
            if (technique) {
                technique.style.display = 'none';
            }
        }

        function showSelfCompassion() {
            const card = document.getElementById('selfCompassionCard');
            if (card) card.style.display = 'block';
        }

        function hideSelfCompassion() {
            const card = document.getElementById('selfCompassionCard');
            if (card) card.style.display = 'none';
        }

        function showProgressReminder() {
            const completedDays = appData.progress.completedDays;
            const completedSections = appData.progress.completedSections;
            
            showToast(`Вы уже прошли ${completedDays} дней практики и заполнили ${completedSections} разделов. Это большой прогресс!`);
        }

        // Initialize app when page loads
        function initializeApp() {
            loadData();
            
            // Set up Telegram WebApp main button
            if (tg && tg.MainButton) {
                tg.MainButton.setText('Сохранить прогресс');
                tg.MainButton.onClick(function() {
                    saveData();
                    showToast('Прогресс сохранен!');
                });
                tg.MainButton.show();
            }
            
            // Auto-save every 5 minutes
            setInterval(saveData, 300000);
        }

        // Handle page visibility change to save data
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveData();
            }
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Fallback initialization
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
